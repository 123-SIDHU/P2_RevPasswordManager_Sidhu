<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Account | RevSecurity</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
</head>

<body>
    <div class="auth-wrapper" style="align-items:flex-start; padding-top: 40px;">
        <div class="auth-card" style="max-width:560px;">
            <div class="auth-logo">
                <div class="logo-icon">üîê</div>
                <span class="logo-text">RevSecurity</span>
            </div>
            <h1 class="auth-title">Create your account</h1>
            <p class="auth-subtitle">Set up your secure password vault</p>

            <div th:if="${errorMsg}" class="alert alert-danger">‚ùå <span th:text="${errorMsg}"></span></div>

            <form method="post" th:action="@{/register}" th:object="${registerDTO}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <!-- Step 1: Account Info -->
                <div class="card mb-4" style="margin-bottom:16px;">
                    <div class="card-title mb-4" style="margin-bottom:12px;">üë§ Account Information</div>

                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" th:field="*{fullName}" placeholder="John Doe" />
                        <div class="text-danger text-sm mt-1" th:if="${#fields.hasErrors('fullName')}"
                            th:errors="*{fullName}"></div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" th:field="*{username}" placeholder="johndoe" />
                            <div class="text-danger text-sm" th:if="${#fields.hasErrors('username')}"
                                th:errors="*{username}"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" th:field="*{email}"
                                placeholder="john@example.com" />
                            <div class="text-danger text-sm" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone (optional)</label>
                        <input type="tel" class="form-control" th:field="*{phone}" placeholder="+91 98765 43210" />
                    </div>
                </div>

                <!-- Step 2: Master Password -->
                <div class="card mb-4" style="margin-bottom:16px;">
                    <div class="card-title mb-4" style="margin-bottom:12px;">üîë Master Password</div>
                    <div class="alert alert-info" style="font-size:12px;">
                        üí° Your master password encrypts your vault. It cannot be recovered without security questions.
                    </div>
                    <div class="form-group">
                        <label class="form-label">Master Password</label>
                        <div class="input-group">
                            <input type="password" id="mp" class="form-control" th:field="*{masterPassword}"
                                placeholder="At least 8 characters" oninput="updateStrength(this.value)" />
                            <button type="button" class="toggle-pw">üëÅÔ∏è</button>
                        </div>
                        <div class="strength-bar mt-1">
                            <div id="strengthFill" class="strength-fill"></div>
                        </div>
                        <div id="strengthLabel" class="strength-label"></div>
                        <div class="text-danger text-sm" th:if="${#fields.hasErrors('masterPassword')}"
                            th:errors="*{masterPassword}"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Master Password</label>
                        <div class="input-group">
                            <input type="password" id="cp" class="form-control" th:field="*{confirmPassword}"
                                placeholder="Repeat master password" />
                            <button type="button" class="toggle-pw">üëÅÔ∏è</button>
                        </div>
                        <div class="text-danger text-sm" th:if="${#fields.hasErrors('confirmPassword')}"
                            th:errors="*{confirmPassword}"></div>
                    </div>
                </div>

                <!-- Step 3: Security Questions -->
                <div class="card mb-4" style="margin-bottom:16px;">
                    <div class="card-title mb-4" style="margin-bottom:12px;">‚ùì Security Questions <span
                            style="font-size:11px;color:var(--text-muted)">(min 3)</span></div>

                    <div th:each="sq, stat : *{securityQuestions}">
                        <div style="background:var(--bg-secondary);border-radius:8px;padding:12px;margin-bottom:10px;">
                            <div class="form-group">
                                <label class="form-label" th:text="'Question ' + (${stat.index + 1})">Question 1</label>
                                <input type="text" class="form-control" th:id="'sq_q_' + ${stat.index}"
                                    th:field="*{securityQuestions[__${stat.index}__].questionText}" autocomplete="off"
                                    placeholder="Enter or select a question" list="securityQuestionSuggestions" />
                                <div class="text-danger text-sm mt-1"
                                    th:if="${#fields.hasErrors('securityQuestions[__${stat.index}__].questionText')}"
                                    th:errors="*{securityQuestions[__${stat.index}__].questionText}"></div>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label class="form-label">Answer</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" th:id="'sq_a_' + ${stat.index}"
                                        th:field="*{securityQuestions[__${stat.index}__].answer}" autocomplete="off"
                                        placeholder="Your answer (case-insensitive)" />
                                    <button type="button" class="toggle-pw">üëÅÔ∏è</button>
                                </div>
                                <div class="text-danger text-sm mt-1"
                                    th:if="${#fields.hasErrors('securityQuestions[__${stat.index}__].answer')}"
                                    th:errors="*{securityQuestions[__${stat.index}__].answer}"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Suggestions Datalist -->
                    <datalist id="securityQuestionSuggestions">
                        <option value="What was your first pet's name?"></option>
                        <option value="What is your mother's maiden name?"></option>
                        <option value="What was the name of your first school?"></option>
                        <option value="In what city were you born?"></option>
                        <option value="What was your favorite childhood book?"></option>
                        <option value="What was the make of your first car?"></option>
                        <option value="What is your favorite teacher's name?"></option>
                    </datalist>
                </div>

                <button type="submit" class="btn btn-primary w-full" style="justify-content:center;">
                    üöÄ Create Account
                </button>
            </form>

            <div class="mt-4" style="text-align:center; font-size:13px; color:var(--text-secondary);">
                Already have an account?
                <a href="/login" style="color:var(--accent-light); text-decoration:none;">Sign in</a>
            </div>
        </div>
    </div>
    <script>
        document.querySelectorAll('.toggle-pw').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = btn.previousElementSibling;
                if (input) {
                    input.type = input.type === 'password' ? 'text' : 'password';
                    btn.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                }
            });
        });
        function updateStrength(pw) {
            let score = 0;
            if (pw.length >= 8) score++;
            if (pw.length >= 12) score++;
            if (/[A-Z]/.test(pw)) score++;
            if (/[0-9]/.test(pw)) score++;
            if (/[^A-Za-z0-9]/.test(pw)) score++;
            score = Math.min(Math.floor(score * 4 / 5), 4);
            const fill = document.getElementById('strengthFill');
            const label = document.getElementById('strengthLabel');
            const widths = ['0%', '25%', '50%', '75%', '100%'];
            const colors = ['', '#ef4444', '#f59e0b', '#22c55e', '#06b6d4'];
            const labels = ['', 'Weak ‚ùå', 'Medium ‚ö†Ô∏è', 'Strong ‚úÖ', 'Very Strong üí™'];
            const classes = ['', 's-weak', 's-medium', 's-strong', 's-vstrong'];
            fill.style.width = widths[score];
            fill.style.background = colors[score];
            label.textContent = labels[score];
            label.className = 'strength-label ' + classes[score];
        }
    </script>
</body>

</html>